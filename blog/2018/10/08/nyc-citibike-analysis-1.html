<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>NYC Citibike Analytics in Real-Time, Part 1 · Perspective</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="There are many well-known perks to living in New York City - the world class"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="NYC Citibike Analytics in Real-Time, Part 1 · Perspective"/><meta property="og:type" content="website"/><meta property="og:url" content="https://perspective.finos.org//blog/2018/10/08/nyc-citibike-analysis-1.html"/><meta property="og:description" content="There are many well-known perks to living in New York City - the world class"/><meta property="og:image" content="https://perspective.finos.org/img/perspective.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://perspective.finos.org/img/perspective.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css"/><link rel="alternate" type="application/atom+xml" href="https://perspective.finos.org/blog/atom.xml" title="Perspective Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://perspective.finos.org/blog/feed.xml" title="Perspective Blog RSS Feed"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:300"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://unpkg.com/@finos/perspective/build/perspective.js"></script><script type="text/javascript" src="https://unpkg.com/@finos/perspective-viewer/build/perspective.view.js"></script><script type="text/javascript" src="https://unpkg.com/@finos/perspective-viewer-hypergrid/build/hypergrid.plugin.js"></script><script type="text/javascript" src="https://unpkg.com/@finos/perspective-viewer-d3fc/build/d3fc.plugin.js"></script><script type="text/javascript" src="js/animation.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><h2 class="headerTitle">Perspective</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/md/installation.html" target="_self">Docs</a></li><li class="siteNavGroupActive"><a href="/blog/" target="_self">Blog</a></li><li class=""><a href="https://github.com/finos/perspective/" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Recent Posts</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Recent Posts</h3><ul class=""><li class="navListItem navListItemActive"><a class="navItem" href="/blog/2018/10/08/nyc-citibike-analysis-1.html">NYC Citibike Analytics in Real-Time, Part 1</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/10/01/v0.2.0-release.html">0.2.0 Release</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer postContainer blogContainer"><div class="wrapper"><div class="lonePost"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"><a href="/blog/2018/10/08/nyc-citibike-analysis-1.html">NYC Citibike Analytics in Real-Time, Part 1</a></h1><p class="post-meta">October 8, 2018</p><div class="authorBlock"><p class="post-authorName"><a href="http://github.com/texodus" target="_blank" rel="noreferrer noopener">Andrew Stein</a></p><div class="authorPhoto"><a href="http://github.com/texodus" target="_blank" rel="noreferrer noopener"><img src="https://avatars3.githubusercontent.com/u/60666?s=400&amp;v=4" alt="Andrew Stein"/></a></div></div></header><div><span><p>There are many well-known perks to living in New York City - the world class
restaurants, museums, two mediocre NFL teams (taken together, that's one pretty
good NFL team!).  Seldom mentioned, though, is the city's world-class Open Data!</p>
<p>In this post, we'll be taking advantage of NYC's abundance of Open Data and
the Perspective library to build some real-time analytics visualizations that
seek to answer one burning question: Where are all of New York's
<a href="https://www.citibikenyc.com/">Citibikes</a>?</p>
<!--truncate-->
<script src="../../../../js/nyc-citibike-analysis/index.js"></script>
<link rel="stylesheet" href="../../../../css/nyc-citibike-analysis/index.css">
<p>Here's what we'll be building, a real-time map of NYC Citibike stations colored
by the number of bikes availble at each.  There is no server involved, all data
subscriptions, analytics logics, and visualization is done entirely in your
browser with Perspective.  This examples is live - go ahead and
try it out!</p>
<p><br/></p>
<div id="grid">
<perspective-viewer row-pivots='["name"]' columns='["num_bikes_available"]' sort='[["num_bikes_available","desc"]]'>
</perspective-viewer>
<perspective-viewer view='xy_scatter' row-pivots='["name"]' columns='["lon","lat","num_bikes_available"]' sort='[["num_bikes_available","asc"]]'>
</perspective-viewer>
</div>
<h2><a class="anchor" aria-hidden="true" id="setup"></a><a href="#setup" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setup</h2>
<p>We're going to need a few libraries, which perspective-heads will no doubt
already be quite familiar with (Yes, perspective-heads is a real term that real
people other than me use):</p>
<pre><code class="hljs css language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/@jpmorganchase/perspective/build/perspective.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/@jpmorganchase/perspective-viewer/build/perspective.view.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/@jpmorganchase/perspective-viewer-hypergrid/build/hypergrid.plugin.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/@jpmorganchase/perspective-viewer-highcharts/build/highcharts.plugin.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>You're also going to need a relatively up-to-date browser, as this example makes use
of several <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/New_in_JavaScript/ECMAScript_Next_support_in_Mozilla">ES2017 features</a>
like <code>async</code>/<code>await</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="getting-the-data"></a><a href="#getting-the-data" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Getting the data</h2>
<p>The <a href="https://www.citibikenyc.com/">NYC Citibike program</a> gratiously provides
access to their <a href="https://www.citibikenyc.com/system-data">real-time station data</a>
via a pretty stand REST/JSON API, and they've even done us the favor of properly
configuring <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a>!
This means we should have no problem fetching and reading this data directly in
a Web Browser, no server required!  From skimming the
<a href="https://github.com/NABSA/gbfs/blob/master/gbfs.md">General Bikeshare Feed Specification</a>,
it looks like the feeds we're interested in are:</p>
<ul>
<li><p><a href="https://gbfs.citibikenyc.com/gbfs/en/station_information.json">station_information.json</a> Mostly static list of all stations, their capacities and locations. Required of systems utilizing docks.</p></li>
<li><p><a href="https://gbfs.citibikenyc.com/gbfs/en/station_status.json">station_status.json</a> Number of available bikes and docks at each station and station availability. Required of systems utilizing docks.</p></li>
</ul>
<p>First thing we're going to want is some rote-standard code to fetch these feeds
via <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest"><code>XMLHttpRequest</code></a>.
As we're going to be making lots of Asynchronous calls in this study, it will be convenient
to write a quick wrapper function <code>get()</code> which wraps up the common boilerplate
for <code>XMLHttpRequest</code> in a <code>Promise</code>;  this will allow us to later call <code>get()</code>
with simpler <code>async</code>/<code>await</code> semantics, even in deeply nested asynchronous code,
greatly simplifying ... well everything, really.  This will also compose nicely
with our <code>perspective</code> API calls we'll be making, as they also exclusively
return <code>Promise</code>s.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params">url</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();
        xhr.open(<span class="hljs-string">"GET"</span>, url, <span class="hljs-literal">true</span>);
        xhr.responseType = <span class="hljs-string">"json"</span>;
        xhr.onload = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> resolve(xhr.response);
        xhr.send(<span class="hljs-literal">null</span>);
    });
}
</code></pre>
<p>Of course, we'd like a function for getting <i>feeds</i> specifically, which
share some common strucutre we can encapsulate in a function, so let's go ahead and make
a specialized function <code>get_feed()</code> just for this purpose.  It will need to take
a <code>feedname</code> to parameterize the URL, and a <code>callback</code> parameter for when we intend
to have the feed <i>polled</i>;  when this parameter is present, we will
continuously <code>get()</code> the feed at some interval and invoke <code>callback</code> with the
results, rather than <code>return</code> them.</p>
<p>From the specification, we know that the data we're interested in is in the
<code>stations</code> field of the object in the <code>data</code> field.  We're also conveniently
provided a TTL value at the top level of each object, which we can use to
calculate a poll frequency for the feed, as we'll want to update it as often
as it is available.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_feed</span>(<span class="hljs-params">feedname, callback</span>) </span>{
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">`https://gbfs.citibikenyc.com/gbfs/en/<span class="hljs-subst">${feedname}</span>.json`</span>;
    <span class="hljs-keyword">const</span> {<span class="hljs-attr">data</span>: {stations}, ttl} = <span class="hljs-keyword">await</span> <span class="hljs-keyword">get</span>(url);
    if (typeof callback === "function") {
        callback(stations);
        setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> get_feed(feedname, callback), ttl * <span class="hljs-number">1000</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> stations;
    }
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="inferring-a-feed-s-i-schema-i"></a><a href="#inferring-a-feed-s-i-schema-i" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Inferring a feed's <i>schema</i></h2>
<p>From looking at the schemas for these feeds, it looks like we're going to want
to join these two feeds on <code>station_id</code>, which means we're going to need to
give Perspective a <i>schema</i> so it knows what column data to expect, as each
row update will only have some fields depending on which feed it is coming from.
Unfortunately, the schemas presented in the specification are not JSON, nor do
they provide their types (both requirements of Perspective);  more
unfortunately, I have the patience of a small child, so spending 10 minutes
manually writing a schema is simply out of the question.  Time to give up!</p>
<p>...</p>
<p>Just kidding - we can trivially utilize Perspective's own column inference to do
this for us!  All we have to do is load the JSON data into a Perspective
<code>table()</code>, then call its <code>schema()</code> method.  First thing's first, though -
Perspective is designed to run in a
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API">Web Worker</a>,
so we'll need to create an instance of one that we can then create <code>table()</code>s
in.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-keyword">const</span> worker = perspective.worker();
</code></pre>
<p>Now the engine is instantiated and we can call methods on it to create &amp;
transform data in a separate Web Worker process.  Let's now use it to make a
function <code>get_schema()</code> for inferring <i>schemas</i> from feeds, since we'll
want to re-use this logic for both of our feeds.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_schema</span>(<span class="hljs-params">feed</span>) </span>{
    <span class="hljs-keyword">const</span> table = worker.table(feed);
    <span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">await</span> table.schema();
    table.delete();
    <span class="hljs-keyword">return</span> schema;
}
</code></pre>
<p>The call to <code>table.delete()</code> is important!  Perspective uses Web Assembly to
achieve its barnstorming performance, and unfortunately as of today,
<a href="https://github.com/WebAssembly/design/issues/1079">Web Assembly does not support VM Garbage Collection</a>;
without this call then, the <code>table()</code> instantiated in this method would
<i>leak</i> when it falls out of scope, leaving the underlying table memory
allocated forever.</p>
<p>With <code>get_schema()</code> in hand, it's easy to create the ultimate merged schema we
seek.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">merge_schemas</span>(<span class="hljs-params">feeds</span>) </span>{
    <span class="hljs-keyword">const</span> schemas = <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all(feeds.map(get_schema));
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.assign({}, ...schemas);
}
</code></pre>
<p>Testing this out in the Chrome Javascript Console is easy!  The Console supports
<code>await</code> directly (unlike Javascript, where this keyword cannot exist outside an
<code>async</code> function block), so all we need to do is copy/paste our function
invocation, exaclty as we'll use it in our finished script.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-keyword">const</span> feednames = [<span class="hljs-string">"station_status"</span>, <span class="hljs-string">"station_information"</span>];
<span class="hljs-keyword">const</span> feeds = <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all(feednames.map(get_feed));
<span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">await</span> merge_schemas(feeds);
</code></pre>
<p>This returns exactly what we were looking for - the merged <i>schema</i> for
the <code>station_status</code> and <code>station_information</code> feeds, with types as inferred by
the Perspective inferrence algorithm directly from the data itself.</p>
<pre><code class="hljs css language-json">{
    <span class="hljs-attr">"station_id"</span>: <span class="hljs-string">"float"</span>,
    <span class="hljs-attr">"num_bikes_available"</span>: <span class="hljs-string">"integer"</span>,
    <span class="hljs-attr">"num_ebikes_available"</span>: <span class="hljs-string">"float"</span>,
    <span class="hljs-attr">"num_bikes_disabled"</span>: <span class="hljs-string">"integer"</span>,
    <span class="hljs-attr">"num_docks_available"</span>: <span class="hljs-string">"integer"</span>,
    <span class="hljs-attr">"num_docks_disabled"</span>: <span class="hljs-string">"float"</span>,
    <span class="hljs-attr">"is_installed"</span>: <span class="hljs-string">"integer"</span>,
    <span class="hljs-attr">"is_renting"</span>: <span class="hljs-string">"integer"</span>,
    <span class="hljs-attr">"is_returning"</span>: <span class="hljs-string">"integer"</span>,
    <span class="hljs-attr">"last_reported"</span>: <span class="hljs-string">"float"</span>,
    <span class="hljs-attr">"eightd_has_available_keys"</span>: <span class="hljs-string">"boolean"</span>,
    <span class="hljs-attr">"eightd_active_station_services"</span>: <span class="hljs-string">"float"</span>,
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"string"</span>,
    <span class="hljs-attr">"short_name"</span>: <span class="hljs-string">"float"</span>,
    <span class="hljs-attr">"lat"</span>: <span class="hljs-string">"float"</span>,
    <span class="hljs-attr">"lon"</span>: <span class="hljs-string">"float"</span>,
    <span class="hljs-attr">"region_id"</span>: <span class="hljs-string">"integer"</span>,
    <span class="hljs-attr">"rental_methods"</span>: <span class="hljs-string">"float"</span>,
    <span class="hljs-attr">"capacity"</span>: <span class="hljs-string">"integer"</span>,
    <span class="hljs-attr">"rental_url"</span>: <span class="hljs-string">"string"</span>,
    <span class="hljs-attr">"eightd_has_key_dispenser"</span>: <span class="hljs-string">"boolean"</span>,
    <span class="hljs-attr">"eightd_station_services"</span>: <span class="hljs-string">"float"</span>,
    <span class="hljs-attr">"has_kiosk"</span>: <span class="hljs-string">"boolean"</span>
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="creating-a-table-by-joining-feeds-with-an-i-index-i"></a><a href="#creating-a-table-by-joining-feeds-with-an-i-index-i" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creating a <code>table</code> by joining feeds with an <i>index</i></h2>
<p>Now that we have our <i>schema</i>, and a convenient <code>get_feed()</code> method for
fetching our feeds, the next step is to load the feeds we've fetched into
Perspective.  The basic data primitive in Perspective is the <code>table()</code> object,
and creating one from a <i>schema</i> is easy - we just pass the <code>schema</code> object
we created above to the <code>table()</code> constructor on the <code>worker</code>, just like we did
for the table we used to infer the constituent <i>schemas</i> in our
<code>get_schema()</code> function.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-keyword">const</span> table = worker.table(schema, {<span class="hljs-attr">index</span>: <span class="hljs-string">"station_id"</span>});
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> feed <span class="hljs-keyword">of</span> feeds) {
    table.update(feed);
}
</code></pre>
<p>Ah, but wait - this is just the state of Citibike at the moment of page load!
What about the real-time support we were promised in the title, and diligently
prepared for in our <code>get_feed()</code> function?  Turns out, that diligent
preparation indeed makes this pretty trivial - we just dispatch our <code>callback</code>
parameter to our <code>table.update()</code> method.  The <i>index</i> field of the
<i>options object</i> passed as the second parameter to
<code>table()</code> makes sure that each updated row overwrites existing <i>rows</i>
joined by <code>station_id</code>, and Perspective's support for
<a href="https://jpmorganchase.github.io/perspective/docs/usage.html#partial-i-row-i-updates-via-undefined">partial updates</a>
means only the fields actually defined in the <code>station_status</code> feed are updated,
while the <code>station_information</code> fields are left alone.  Without this property,
<i>rows</i> added via the <code>table.update()</code> method would simply append, and we'd
need to join the <code>station_status</code> fields with the <code>station_information</code> fields
via a much more complex <code>&lt;perspective-viewer&gt;</code> configuration.</p>
<pre><code class="hljs css language-javascript">get_feed(<span class="hljs-string">"station_status"</span>, table.update);
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="loading-a-table-in-a-perspective-viewer"></a><a href="#loading-a-table-in-a-perspective-viewer" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Loading a <code>table</code> in a <code>&lt;perspective-viewer&gt;</code></h2>
<p>Now that we have a <code>table()</code> with our Citibike subscription all wired up, the
last thing to do is view it!  For this, we need a <code>&lt;perspective-viewer&gt;</code>.  We
could create one via Javascript through the standard DOM APIs such as
<code>document.createElement()</code>, but one of the nice features of
<a href="">Web Components</a> is that they can be used declaritively directly in your
application's HTML without any special pre-processing.</p>
<pre><code class="hljs css language-html"><span class="hljs-tag">&lt;<span class="hljs-name">perspective-viewer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">perspective-viewer</span>&gt;</span>
</code></pre>
<p>Next, we capture references to all <code>&lt;perspective-viewer&gt;</code>s on our page through
the standard DOM APIs, such that we may call their side-effecting
methods such as <code>load()</code>, which we'll use to bind our Citibike <code>table()</code>.
We can freely share this <code>table()</code> among as many <code>&lt;perspective-viewer&gt;</code>s as
we need, so we'll just iterate through all of them - even our <code>update()</code> calls
will be shared, causing all bound <code>&lt;perspective-viewer&gt;</code>s to re-render when
the <code>table()</code> changes.</p>
<pre><code class="hljs css language-javascript"><span class="hljs-keyword">for</span> (viewer <span class="hljs-keyword">of</span> <span class="hljs-built_in">document</span>.getElementsByTagName(<span class="hljs-string">"perspective-viewer"</span>)) {
    viewer.load(table);
}
</code></pre>
<p>And just like that, we have our live, joined dataset loaded in a fully interactive
<code>&lt;perspective-viewer&gt;</code>, ready to slice &amp; dice!  (This isn't a screenshot, its
a live perspective viewer with real data, so go ahead and play around!)</p>
<p><br/></p>
<div>
<perspective-viewer id="view1">
</perspective-viewer>
</div>
<h2><a class="anchor" aria-hidden="true" id="where-are-the-citibikes"></a><a href="#where-are-the-citibikes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Where are the Citibikes?</h2>
<p>While we can see our data now and transform/visualize it to our heart's content,
the default view on initial load is not super interesting, so let's <i>kick it
up a notch!</i>  Wait, no, that's probably going to get us in trouble ... er,
let's <i>put some Perspective on it!</i></p>
<p>Regarding our instigating question, there are a number of good potential
visualizations that may help us understand the answer, including
an incredibly obvious and easy one - a list of Citibike stations ordered by
the <code>&quot;num_bikes_available&quot;</code>.  We can make this the default view on a
<code>&lt;perspective-viewer&gt;</code> easily in HTML, through its
<a href="https://jpmorganchase.github.io/perspective/docs/usage.html#setting-reading-viewer-configuration-via-attributes">Attribute API</a>.</p>
<p>In this case, we'll want to set the <code>columns</code> attribute to our column set,
<code>[&quot;num_bikes_available&quot;]</code>, and the <code>sort</code> attribute to a list of sort
descriptors <code>[[&quot;num_bikes_available&quot;,&quot;desc&quot;]]</code>, or in other words, that we
want the list arranged with the values of the <code>&quot;num_bikes_available&quot;</code> column
descending.  We also provide the <code>&quot;name&quot;</code> field to the <code>row-pivots</code> property,
though there will only be one row in the Citibike data per <code>&quot;name&quot;</code>.  While we
could have accomplished something similar by leaving this view un-pivoted and
instead added <code>&quot;name&quot;</code> to the <code>columns</code> attribute, making it a <code>row-pivot</code>
gives us a pretty tree axis indicating visually that <code>&quot;name&quot;</code> is the intended
<i>axis</i> of the view, as well as creating a <code>TOTAL</code> aggregate row showing
the sum total of all <code>&quot;num_bikes_available&quot;</code>.</p>
<pre><code class="hljs css language-html"><span class="hljs-tag">&lt;<span class="hljs-name">perspective-viewer</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"top-by-availble-bikes"</span>
    <span class="hljs-attr">row-pivots</span>=<span class="hljs-string">'["name"]'</span>
    <span class="hljs-attr">columns</span>=<span class="hljs-string">'["num_bikes_available"]'</span>
    <span class="hljs-attr">sort</span>=<span class="hljs-string">'[["num_bikes_available","desc"]]'</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">perspective-viewer</span>&gt;</span>
</code></pre>
<p>Because our <code>table()</code> are shared, we can easily make another view on the
same data by just configuring another <code>&lt;perspective-viewer&gt;</code> - how about a
heat map of station availability?  The schema conveniently has <code>lon</code> and <code>lat</code>
fields, which one surmise stand for Longitude and Latitude.<br>
<code>&lt;perspective-viewer&gt;</code> uses hard-coded mappings for displaying a <code>view()</code>
configuration, and for Scatter Charts, it maps selected
<code>columns</code> to &quot;X Axis&quot;, &quot;Y Axis&quot;, &quot;Color&quot; and &quot;Size&quot; in that order.  Sure enough,
setting columns to <code>lon</code> and <code>lat</code>, plus an interesting field like
<code>num_bikes_available</code>, as well as the <code>view</code> attribute to <code>xy_scatter</code>,
should give us something that looks roughly like the classic profile of the Five
Bouroughs, colored by Citibike availability:</p>
<pre><code class="hljs css language-html"><span class="hljs-tag">&lt;<span class="hljs-name">perspective-viewer</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"available-bikes-heatmap"</span>
    <span class="hljs-attr">view</span>=<span class="hljs-string">'xy_scatter'</span>
    <span class="hljs-attr">row-pivots</span>=<span class="hljs-string">'["name"]'</span>
    <span class="hljs-attr">columns</span>=<span class="hljs-string">'["lon","lat","num_bikes_available"]'</span>
    <span class="hljs-attr">sort</span>=<span class="hljs-string">'[["num_bikes_available","asc"]]'</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">perspective-viewer</span>&gt;</span>
</code></pre>
<p>Finally, at long last, we have our live &amp; ticking Citibike Analytics Dashboard:</p>
<p><br/></p>
<div id="grid">
<perspective-viewer id="view3" row-pivots='["name"]' columns='["num_bikes_available"]' sort='[["num_bikes_available","desc"]]'>
</perspective-viewer>
<perspective-viewer id="view2" view='xy_scatter' row-pivots='["name"]' columns='["lon","lat","num_bikes_available"]' sort='[["num_bikes_available","asc"]]'>
</perspective-viewer>
</div>
<h2><a class="anchor" aria-hidden="true" id="appendix-the-entire-application"></a><a href="#appendix-the-entire-application" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Appendix - the Entire Application</h2>
<p>For your covenience, the entire Javascript application at once is available
<a href="https://github.com/jpmorganchase/perspective/blob/master/examples/simple/citibike.html">in the <code>examples/</code> directory of the Perspective github repository</a>, as well as
<a href="https://jsfiddle.net/texodus/m2rwz690">in a JSFiddle</a></p>
</span></div></div><div class="blogSocialSection"></div></div><div class="blog-recent"><a class="button" href="/blog">Recent Posts</a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#setup">Setup</a></li><li><a href="#getting-the-data">Getting the data</a></li><li><a href="#inferring-a-feed-s-i-schema-i">Inferring a feed's &lt;i&gt;schema&lt;/i&gt;</a></li><li><a href="#creating-a-table-by-joining-feeds-with-an-i-index-i">Creating a <code>table</code> by joining feeds with an &lt;i&gt;index&lt;/i&gt;</a></li><li><a href="#loading-a-table-in-a-perspective-viewer">Loading a <code>table</code> in a <code>&lt;perspective-viewer&gt;</code></a></li><li><a href="#where-are-the-citibikes">Where are the Citibikes?</a></li><li><a href="#appendix-the-entire-application">Appendix - the Entire Application</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"></a><div><h5>Docs</h5><a href="/docs/en/md/installation.html">Installation</a><a href="/docs/en/md/usage.html">Usage</a><a href="/docs/en/obj/perspective.html">Perspective API</a><a href="/docs/en/obj/perspective-viewer.html">Perspective Viewer API</a></div><div><h5>More</h5><a href="/blog">Blog</a><a href="https://github.com/finos/perspective/">GitHub</a><a class="github-button" data-icon="octicon-star" data-count-href="/facebook/docusaurus/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright">Copyright © 2019 Perspective Authors</section></footer></div></body></html>